# Запрос

Вам никогда не было интересно как Drupal делает, то что он делает? Хорошо, мне тоже. В этой серии статей, я собираюсь объяснить что происходит за сценой, когда Drupal творит свою чудеса.

In Part 1, we'll keep it fairly high level and walk through the path a request takes as it moves through Drupal. In later parts, we'll take deeper dives into individual pieces of this process.

## Шаг 0: Некоторая справочная информация

Для этого примера, давайте договоримся что Джордж, пользователь вашего сайта, хочет посетить страница About Us, которая находится по адресу `http://oursite/about-us`.

Также давайте договоримся что эта страница - материал (материал у которого `nid` равен `1`) URL синоним у которого `about-us`.

Чтобы не усложнять, условимся что мы используем вебсервер Apache, and there's nothing fancy sitting in front of Drupal, such as a caching layer or the like. 

**То есть мы говорим о старом добром Drupal на старом добром вебсервере.**

## Шаг 1: Запрос достигает сервера

Тут есть несколько выжных действий, до того как Drupal увидит этот запрос. Браузер Джорджа отправил запрос по адресу `http://oursite.com/about-us`, и штука, которую мы называем интернет делает все, чтобы мы смогли благополучно добраться до сервера. Если вы хотите детальнее узнать, как это происходит, то прочитайте [как работает интернет](http://i.imgur.com/fzY1Arg.jpg).

Как только наш сервер, получает запрос, начинается магия. По прибытию этот запрос обратиться в порт `80`, а на этом порту его уже ждет Apache, так что Apache немедлено заметит запрос и уже теперь он будет решать, что с ним делать.

Так как запрос направляется в `oursite.com` Apache будет просматрить свои настройки, чтобы найти корневую директорию для домена `oursite.com` (along with lots of other info about it which is out of scope for this post). Пусть корневая директория для нашего сайта `/var/www/oursite`, это место, где живет Drupal. Так что Apache собирается отправить запрос Джорджа туда.

## Шаг 2: Файл .htaccess 

В корне Drupal есть файл `.htaccess` в котором хранятся инструкции для Apache. И перед тем как продолжит Apache сначала выполнит их все. Самые важные из них:

1. Закрыть от просмотра файлы в которых может содержаться исходный код, такие файлы как `.module` или `.inc`, в которых находитися PHP код.
2. Отправлять запросы, которые идут к обычным файлам (изображения, ), напрямую при этом не затрагивая Drupal.
3. Все остальные запросы он перенаправлять в файл `index.php`.

Также в `.htaccess` присутсвуют и другие инструкции: закрывать индексацию директорий, сжимать файлы CSS и JS, и т.д, но они играют вторую роль.

В нашем случаем Apache знает, что мы ищем `/about-us` и затем воспользуется инструкциями из `.htaccess`, чтобы ответить на вопросы:

1. *Запрос пытается получить доступ к файлу, к которому его нельзя пускать? Нет.*
2. *Запрос хочет получить доступ к файлу, который есть в файловой системе? Нет.*
3. *Тогда этот запрос отправляется в `index.php`!*

Продолжим...

## Шаг 3: Файл index.php

Наконец-то мы добрались до Drupal, и мы смотрим на PHP код. Файл index.php в Drupal очень простой, там всего 4 строки кода, каждую из которых легко понять.

### Строка 1: Задаеём DRUPAL_ROOT

```php
define('DRUPAL_ROOT', getcwd());
```

Задает константу с именем `DRUPAL_ROOT` а в её значение мы поместим путь до папки в которой находиться файл `index.php`. Эта константа [используется повсюду](https://api.drupal.org/api/drupal/index.php/constant/constants/DRUPAL_ROOT/7) в ядре Drupal.

В нашем случае `DRUPAL_ROOT` примет значение `/var/www/oursite`.

### Строка 2 и 3: Drupal бутстрап

```php
require_once DRUPAL_ROOT . '/includes/bootstrap.inc';
drupal_bootstrap(DRUPAL_BOOTSTRAP_FULL);
```

Эти строки запускают полный Drupal бутстрап, то есть они говорят: "Эй Drupal, подготовь всё необходимое, перед тем как мы начнем обрабатывать этот запрос."

**Подробнее бутстрап будет рассматриваться во 2 главе.**

### Строка 4: Делаем все остальное

```php
menu_execute_active_handler();
```

Эта на первый взгляд неприметная функция, плоть и кровь Drupal.

**Подробнее резберем эту функция в 3 главе.**